<!--<%#= hidden_field_tag "table_id",table_id %>-->
<% @send_ad = Advertisement.find(media_selected_list.last.advertisement_id) %>
<% @current_ad = Advertisement.find(table_id) %>
<div class="row b_margin_5">
  <div class="span">
    <label class="sub_txt2">
      <span><%= @send_ad.get_advertisements_live + @send_ad.product.name %></span>
    </label>
  </div>
</div>
<div class="row ">
      <div class="table_white" style="position: relative;">
        <table class="table table-striped table-bordered table-condensed unlimited_width search_table dataTabl" cellpadding="0" cellspacing="0" border="0" class="display" id="media_list_selected_<%= table_id %>" >
          <thead>
          <tr>
            <th class="align_left aligntop"></th>
            <th class="align_left align_top"><%= t("order.form.geo_column")%></th>
            <th class="align_left align_top"><%= t("order.form.site_name_column")%></th>
            <th class="align_left align_top"><%= t("order.form.site_type_column")%></th>
            <th class="align_left align_top"><%= t("order.form.ad_type_column")%></th>
            <th class="align_left align_top"><%= t("order.form.origin_size_column")%></th>
            <th class="align_left align_top"><%= t("order.form.stand_extend_size_column")%></th>
            <th class="align_left align_top"><%= t("order.form.ref_ctr")%></th>
            <% if @current_ad.ad_type == "BAN" %>
                <th class="align_left align_top"><%= t("order.form.clicks_allocation_column")%></th>
                <th class="align_left align_top"><%= t("order.form.clicks_allocation_rate_column")%></th>
            <% else %>
                <th class="align_left align_top"><%= t("order.form.impressions_allocation_column")%></th>
                <th class="align_left align_top"><%= t("order.form.impressions_allocation_rate_column")%></th>
            <% end %>
          </tr>
          </thead>
          <tbody id="book_pv_table">
          <% city_pre_index = -1 %>
          <%if media_selected_list %>
              <% city_media = media_selected_list.group_by(&:city) %>

              <% city_media.each do |k,media| %>
               <% max_pv= 0 %>
               <% media.each_with_index do |book,index| %>
                 <% max_pv += book.pv_config.to_i %>
                      <% city_pre_index += 1 %>
                      <tr>



                            <% if @send_ad.ad_type == "BAN" %>
                                <td class="align_center v_align_middle"  width="20px">
                                </td>
                            <% else %>
                                <td class="align_center v_align_middle"  width="20px">
                                  <a href="#pv_config_form" onclick="remove_city_config('<%= book.city %>',<%= table_id%>)" ><img src='/images/btn_del.png' style="cursor: pointer"  id="remove_tag"/></a>
                                </td>
                            <% end %>


                    <td class="align_left v_align_middle" id="pre_city_<%= city_pre_index %>" >
                      <%=  Order.map_region_names(book.city)%>
                    </td>
                    <td class="align_left v_align_middle" >
                      <%= book.media %>
                    </td>
                    <td class="align_left v_align_middle">
                      <%= book.media_type %>
                    </td>
                    <td class="align_left v_align_middle">
                      <%= book.media_form %>
                    </td>
                    <td class="align_left v_align_middle">
                      <%= book.ad_original_size %>
                    </td>
                    <td class="align_left v_align_middle" >
                      <%= book.ad_expand_size %>
                    </td>
                    <td class="align_right v_align_middle">
                      <%= book.ctr.present? ? number_with_precision(book.ctr, :precision => 2) : 0.00 %>
                    </td>
                    <td class="align_right v_align_middle">
                      <%= number_with_precision(book.pv_config, :precision => 0, :delimiter => ",") %>K
                    </td>
                    <td class="align_right v_align_middle">
                      <%= sprintf("%.2f",book.pv_config_scale) %>%
                    </td>
                  </tr>
              <% end%>
                  <tr class="odd" >
                    <% city_pre_index=city_pre_index+1 %>
                    <td></td>
                    <td id="pre_city_<%= city_pre_index%>"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td style="display: none"></td>
                    <% if @current_ad.ad_type == "BAN" %>
                      <td class="align_right" colspan='2'><%= t("order.form.total_clicks")%></td>
                    <% else %>
                      <td class="align_right" colspan='2'><%= t("order.form.total_impressions")%></td>
                    <% end %>
                    <td class="align_right"><%= number_with_precision(max_pv, :precision => 0, :delimiter => ",") %><span>K</span></td>
                    <td class="align_right">100.00%</td>
                  </tr>
          <%end%>
          <% end %>
          </tbody>
          <tbody>
          <tr>
            <td class="align_left  v_align_middle"  width="20px"  colspan="10" style="border-top: 1px dotted;border-color: #BEBEBE">
              <%=raw return_gp_img(@send_ad.get_advertisement_gps_rake) %>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>


<script type="text/javascript">

window.mediaSelect = function (){
window.mediaSelected = $("#media_list_selected_<%=table_id%>").dataTable({
// 上线请替换成,保持和原来table一致 ->"oLanguage": { "sUrl": "/javascripts/i18n/dataTables-new.zh-cn.txt" },
"oLanguage": {"sUrl": "/javascripts/i18n/dataTables-new.<%= I18n.locale.to_s%>.txt"},
"sDom": "t<'row table_bottom'<'table_pagin'p><'table_info'i>>",
"sPaginationType": "full_numbers",
"bPaginate": true,
"bFilter": false,
"iDisplayLength": 10,
"bLengthChange": false,
"bAutoWidth": false,
"aaSorting": [],
"aoColumns" : [
{ "sType": "boolean", "sWidth": "5px","bSortable": false },

{ "sType": "string", "sWidth": "80px","className":'details-control'},
{ "sType": "string", "sWidth": "50px" },
{ "sType": "string", "sWidth": "80px" },
{ "sType": "string", "sWidth": "80px" },
{ "sType": "string", "sWidth": "50px" },
{ "sType": "string", "sWidth": "100px" },
{ "sType": "string", "sWidth": "80px" },
{ "sType": "string", "sWidth": "80px" },
{ "sType": "string", "sWidth": "80px" }
],
    "fnCreatedRow" : function(nRow, aData, iDisplayIndex) {
        if((iDisplayIndex % 10) != 0){
                var pre_city = $("#pre_city_"+(iDisplayIndex-1)).text().replace(/\s/g,"");;
                if (aData[1] != "" && aData[1] == pre_city) {
                    $('td:eq(0)',nRow).html("");

            }
        }
        return nRow;
    }
});
}
mediaSelect();


function remove_city_config(city,ad_id) {
//    var order_status = $(".xmo-progress-status [order_id = "+ <%#= @order.id %> +"]").last().attr('status').split(",");
//    var pre_check_status = order_status[0]
    $.ajax({
        type: "GET",
//        url: "/<%= I18n.locale.to_s%>/gps/ajax_remove_pv_config?ad_id=" +  ad_id + "&&city=" + city + "&&node_id= 1 &&status="+ pre_check_status,
        url: "/<%= I18n.locale.to_s%>/gps/ajax_remove_pv_config?ad_id=" +  ad_id + "&&city=" + city,

        dataType:"text",
        success: function(msg){
            $('#pv_config_form').html(msg);
        },
        error: function(msg){
        }
    });

}



</script>